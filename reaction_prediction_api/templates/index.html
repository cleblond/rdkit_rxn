<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organic Reaction Predictor</title>
    
    <script src="{{ url_for('serve_kekule', filename='dist/kekule.js') }}"></script>
    
    <link rel="stylesheet" href="{{ url_for('serve_kekule', filename='dist/themes/default/kekule.css') }}">
    
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .reactants-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .reactant-box {
            flex: 1;
            min-width: 300px;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }
        .reactant-box h3 {
            margin-top: 0;
            color: #34495e;
            text-align: center;
        }
        .kekule-container {
            height: 200px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            background: white;
        }
        .smiles-display {
            font-family: monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            border: 1px dashed #ddd;
            font-size: 12px;
            min-height: 20px;
            word-break: break-all;
        }
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        
	.app-button {
	    background-color: #3498db;
	    color: white;
	    padding: 12px 24px;
	    border: none;
	    border-radius: 5px;
	    cursor: pointer;
	    font-size: 16px;
	    min-width: 200px;
	}
	.app-button:hover {
	    background-color: #2980b9;
	}
	.app-button:disabled {
	    background-color: #95a5a6;
	    cursor: not-allowed;
	}
        
        .loading {
            text-align: center;
            display: none;
            margin: 20px 0;
        }
        .results {
            margin-top: 30px;
            display: none;
        }
        .reaction-card {
            background: #ecf0f1;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        .reaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .reaction-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 18px;
            text-transform: capitalize;
        }
        .score {
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
        }
        .products {
            margin-top: 10px;
        }
        .product {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 3px;
            font-family: monospace;
        }
        .reasons {
            font-style: italic;
            color: #7f8c8d;
            margin-top: 10px;
            font-size: 14px;
        }
        .error {
            color: #e74c3c;
            background: #fadbd8;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .success {
            color: #27ae60;
            background: #d5f4e6;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .toolbar {
            text-align: center;
            margin: 10px 0;
        }
        .toolbar button {
            padding: 6px 12px;
            font-size: 12px;
            min-width: auto;
            margin: 0 5px;
            background-color: #7f8c8d;
        }
        .toolbar button:hover {
            background-color: #95a5a6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Organic Reaction Predictor</h1>
        
        <div class="reactants-container">
            <div class="reactant-box">
                <h3>Reactant 1</h3>
                <div id="reactant1Editor" class="kekule-container"></div>
                <div class="toolbar">
		    <button class="app-button" onclick="clearMolecule('reactant1')">Clear</button>
		    <button class="app-button" onclick="loadExample('reactant1', 'CC(=O)O')">Load Acid</button>
                </div>
                <div>SMILES: <span id="reactant1Smiles" class="smiles-display">Not set</span></div>
            </div>
            
            <div class="reactant-box">
                <h3>Reactant 2 (Optional)</h3>
                <div id="reactant2Editor" class="kekule-container"></div>
                <div class="toolbar">
		    <button class="app-button" onclick="clearMolecule('reactant2')">Clear</button>
		    <button class="app-button" onclick="loadExample('reactant2', 'CN')">Load Amine</button>
		    <button class="app-button" onclick="loadExample('reactant2', 'CCO')">Load Alcohol</button>
                </div>
                <div>SMILES: <span id="reactant2Smiles" class="smiles-display">Not set</span></div>
            </div>
        </div>
        
        <div class="button-container">
            <button onclick="predictReactions()">Predict Reactions</button>
        </div>
        
        <div class="loading" id="loading">
            <p>ðŸ”¬ Analyzing molecules and predicting reactions...</p>
        </div>
        
        <div class="results" id="results">
            <h2>Prediction Results</h2>
            <div id="resultsContainer"></div>
        </div>
    </div>

    <script>
        // Kekule.js editors
        let reactant1Editor = null;
        let reactant2Editor = null;
        
        // Initialize Kekule.js editors when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize reactant 1 editor
            //reactant1Editor = new Kekule.ChemWidget.Viewer2D('reactant1Editor');
            reactant1Editor = new Kekule.ChemWidget.Viewer(document.getElementById('reactant1Editor'));
            
            /*
            reactant1Editor.setEnableToolbar(true)
            	  .setEnableDirectInteraction(true)
		  .setEnableEdit(true)
		  .setToolButtons([
		    'loadData', 'saveData', 'molDisplayType', 'molHideHydrogens',
		    'zoomIn', 'zoomOut',
		    'rotateLeft', 'rotateRight', 'rotateX', 'rotateY', 'rotateZ',
		    'reset', 'openEditor', 'config'
		  ]);
		*/  
            reactant1Editor.setPredefinedSetting('editOnly');
            
            
            
            var cmlData1 = '<cml xmlns="http://www.xml-cml.org/schema"><molecule id="m1"><atomArray><atom id="a1" elementType="C" x2="14.399999999999984" y2="46.39999999999995"/><atom id="a2" elementType="O" x2="15.092820323027535" y2="45.99999999999995"/><atom id="a4" elementType="O" x2="14.399999999999984" y2="47.19999999999995"/><atom id="a3" elementType="C" x2="13.707179676972434" y2="45.99999999999995"/></atomArray><bondArray><bond id="b1" order="S" atomRefs2="a1 a2"/><bond id="b3" order="D" atomRefs2="a1 a4"/><bond id="b2" order="S" atomRefs2="a1 a3"/></bondArray></molecule></cml>';            
            

	        var myMolecule = Kekule.IO.loadFormatData(cmlData1, 'cml');
	        reactant1Editor.setChemObj(myMolecule);
            
            //reactant1Editor.appendToWidget();
            
            // Initialize reactant 2 editor
            reactant2Editor = new Kekule.ChemWidget.Viewer(document.getElementById('reactant2Editor'));
            //reactant2Editor.setEnableToolbar(true);
            reactant2Editor.setPredefinedSetting('editOnly');
            var cmlData2 = '<cml xmlns="http://www.xml-cml.org/schema"><molecule id="m1"><atomArray><atom id="a2" elementType="C" x2="7.493264658965051" y2="35.58088907877604"/><atom id="a3" elementType="O" x2="8.186084981992602" y2="35.18088907877604"/><atom id="a1" elementType="C" x2="6.800444335937501" y2="35.18088907877604"/></atomArray><bondArray><bond id="b2" order="S" atomRefs2="a2 a3"/><bond id="b1" order="S" atomRefs2="a2 a1"/></bondArray></molecule></cml>'; 

            var myMolecule = Kekule.IO.loadFormatData(cmlData2, 'cml');
	        reactant2Editor.setChemObj(myMolecule);     
            
            
            //reactant2Editor.appendToWidget();
            // Load default examples
            //loadExample('reactant1', 'CC(=O)O'); // Acetic acid
            //loadExample('reactant2', 'CN');      // Methylamine
            
            // Add change listeners to update SMILES display
            reactant1Editor.addEventListener('molChange', function() {
                console.log("molchange");
                updateSmilesDisplay('reactant1');
            });
            
            reactant2Editor.addEventListener('molChange', function() {
                updateSmilesDisplay('reactant2');
            });
        });
        
        function getEditor(reactantId) {
            return reactantId === 'reactant1' ? reactant1Editor : reactant2Editor;
        }
        
        
        
        
        
        function clearMolecule(reactantId) {
            const editor = getEditor(reactantId);
            editor.setChemObj(null);
            document.getElementById(reactantId + 'Smiles').textContent = 'Not set';
        }
        
        function updateSmilesDisplay(reactantId) {
            const editor = getEditor(reactantId);
            const molecule = editor.getChemObj();
            if (molecule) {
                try {
                    const smiles = Kekule.IO.saveFormatData(molecule, 'smi');
                    document.getElementById(reactantId + 'Smiles').textContent = smiles;
                } catch (error) {
                    document.getElementById(reactantId + 'Smiles').textContent = 'Error generating SMILES';
                }
            } else {
                document.getElementById(reactantId + 'Smiles').textContent = 'Not set';
            }
        }
        
        function getSmilesFromEditor(reactantId) {
            const editor = getEditor(reactantId);
            const molecule = editor.getChemObj();
            if (molecule) {
                try {
                    return Kekule.IO.saveFormatData(molecule, 'smi');
                } catch (error) {
                    console.error('Error converting to SMILES:', error);
                    return null;
                }
            }
            return null;
        }
        
        async function predictReactions() {
            const smiles1 = getSmilesFromEditor('reactant1');
            const smiles2 = getSmilesFromEditor('reactant2');
            
            if (!smiles1) {
                alert('Please draw a molecule for Reactant 1');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        reactant1: smiles1,
                        reactant2: smiles2
                    })
                });
                
                const data = await response.json();
                
                // STORE THE RESPONSE PROPERLY
                window.lastResponse = data; // This is the key line!
                
                // Hide loading
                document.getElementById('loading').style.display = 'none';
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                displayResults(data);
                
                console.log(data);
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                showError('Network error: ' + error.message);
            }
        }
        
        
        
        
        
        
        function displayResults(data) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            
            if (data.total_reactions_found === 0) {
                container.innerHTML = `
                    <div class="error">
                        No plausible reactions found for the given reactants.
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="success">
                        Found ${data.total_reactions_found} possible reaction(s) for: 
                        ${data.reactants.join(' + ')}
                    </div>
                `;
                
                data.reactions.forEach((reaction, reactionIndex) => {
                    const reactionHtml = `
                        <div class="reaction-card">
                            <div class="reaction-header">
                                <span class="reaction-name">${reaction.reaction_name.replace(/_/g, ' ')}</span>
                                <span class="score">Score: ${reaction.score.toFixed(2)}</span>
                            </div>
                            <div class="reasons">
                                ${reaction.reasons.join(' â€¢ ')}
                            </div>
                            <div class="products">
                                <strong>Products:</strong>
                                ${reaction.products.map((product, productIndex) => {
                                    const viewerId = `viewer-${reactionIndex}-${productIndex}`;
                                    return `
                                        <div class="product">
                                            <div class="product-info">
                                                <div class="smiles-label">SMILES: </div>
                                                <div class="smiles-value">${product}</div>
                                            </div>
                                            <div class="product-viewer-container">
                                                <div id="${viewerId}" class="kekule-container" style="height: 150px;"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    container.innerHTML += reactionHtml;
                });
                
                // Auto-load all 2D structures after rendering
                setTimeout(() => {
                    data.reactions.forEach((reaction, reactionIndex) => {
                        reaction.products.forEach((product, productIndex) => {
                            const viewerId = `viewer-${reactionIndex}-${productIndex}`;
                            loadCmlTo2DViewer(viewerId, reactionIndex, productIndex, data);
                        });
                    });
                }, 100);
            }
            
            document.getElementById('results').style.display = 'block';
        }


        function loadCmlTo2DViewer(viewerId, reactionIndex, productIndex, responseData) {
            const viewerElement = document.getElementById(viewerId);
            
            console.log(viewerElement);
            
            try {
                viewerElement.innerHTML = '';
                
                const viewer = new Kekule.ChemWidget.Viewer(viewerElement);
                //viewer.setPredefinedSetting(Kekule.Widget.Setting.DEFAULT_MOLECULE_2D);
                //viewer.setEnableToolbar(false);
                
                // Get the product data from the response
                console.log(viewer);
                console.log(responseData);
                const reaction = responseData.reactions[reactionIndex];
                console.log(reaction);
                const productSmiles = reaction.products[productIndex];
                
                const cmlData = reaction.products_cmls[productIndex];
                
                console.log(cmlData);
                
                if (cmlData && !cmlData.startsWith('# Could not generate')) {
                    // Use CML for better coordinates
                    try {
                        //console.log(Kekule.IO.DataFormat);
                        const molecule = Kekule.IO.loadFormatData(cmlData, 'cml');
                        console.log(molecule);
                        if (molecule) {
                            viewer.setChemObj(molecule);
                            //viewer.appendToWidget();
                            return;
                        }
                    } catch (cmlError) {
                        console.log('CML loading failed, falling back to SMILES:', cmlError);
                        // Continue to SMILES fallback
                    }
                }
                
                // Fallback to SMILES if CML is not available or failed
                const molecule = Kekule.IO.loadFormatData(productSmiles, 'smi');
                if (molecule) {
                    viewer.setChemObj(molecule);
                    viewer.appendToWidget();
                    setTimeout(() => {
                        try {
                            viewer.zoomToFit();
                        } catch (e) {
                            console.log('Zoom failed:', e);
                        }
                    }, 50);
                } else {
                    throw new Error('Failed to parse molecule');
                }
                
            } catch (error) {
                console.error('Error loading molecule:', error);
                viewerElement.innerHTML = `
                    <div class="error" style="padding: 5px; font-size: 12px;">
                        Failed to display structure
                    </div>
                `;
            }
        }







        // Function to load SMILES into a 2D viewer
        function loadSmilesToViewer(viewerId, smiles) {
            const viewerElement = document.getElementById(viewerId);
            
            try {
                // Clear any existing content
                viewerElement.innerHTML = '';
                
                // Create a new 2D viewer
                const viewer = new Kekule.ChemWidget.Viewer2D(viewerElement);
                viewer.setPredefinedSetting('editOnly');
                //viewer.setPredefinedSetting(Kekule.Widget.Setting.DEFAULT_MOLECULE_2D);
                viewer.setEnableToolbar(false); // Disable toolbar for cleaner look
                
                // Load the SMILES directly
                const molecule = Kekule.IO.loadFormatData(smiles, 'smi');
                if (molecule) {
                    viewer.setChemObj(molecule);
                    viewer.appendToWidget();
                    
                    // Center and fit the molecule in the viewer
                    setTimeout(() => {
                        viewer.zoomToFit();
                    }, 50);
                } else {
                    throw new Error('Failed to parse SMILES');
                }
            } catch (error) {
                console.error('Error loading SMILES:', error, smiles);
                viewerElement.innerHTML = `
                    <div class="error" style="padding: 5px; font-size: 12px;">
                        Failed to display structure
                    </div>
                `;
            }
        }

        // Store the last response globally
        let lastResponse = null;
        
        
        
        
        
        
        
        
        
        function displayResults_old(data) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';
            
            if (data.total_reactions_found === 0) {
                container.innerHTML = `
                    <div class="error">
                        No plausible reactions found for the given reactants.
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="success">
                        Found ${data.total_reactions_found} possible reaction(s) for: 
                        ${data.reactants.join(' + ')}
                    </div>
                `;
                
                data.reactions.forEach(reaction => {
                    const reactionHtml = `
                        <div class="reaction-card">
                            <div class="reaction-header">
                                <span class="reaction-name">${reaction.reaction_name.replace(/_/g, ' ')}</span>
                                <span class="score">Score: ${reaction.score.toFixed(2)}</span>
                            </div>
                            <div class="reasons">
                                ${reaction.reasons.join(' â€¢ ')}
                            </div>
                            <div class="products">
                                <strong>Products:</strong>
                                ${reaction.products.map(product => `
                                    <div class="product">${product}</div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    container.innerHTML += reactionHtml;
                });
            }
            
            document.getElementById('results').style.display = 'block';
        }
        
        function showError(message) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `
                <div class="error">
                    Error: ${message}
                </div>
            `;
            document.getElementById('results').style.display = 'block';
        }
    </script>
</body>
</html>
